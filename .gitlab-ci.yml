stages:
  - build
  - image

build_project:
  image: golang:1.9.2-alpine3.7
  stage: build
  script:
    - apk --no-cache add build-base git
    - go get github.com/constabulary/gb/...
    - ln -s /builds /go/src/gitlab.com
    - cd /go/src/gitlab.com/${CI_PROJECT_PATH}
    - GOOS=linux GOARCH=amd64 gb build
    - mv bin/server-linux-amd64 bin/server
  artifacts:
    paths:
      - bin/server
  cache:
    paths:
      - bin/server

build_docker_image:
  image: centos:latest
  stage: image
  variables:
    DOCKER_DRIVER: overlay2
  services:
    - docker:dind
  script:
    - cd /builds/${CI_PROJECT_PATH}
    - cp /etc/ssl/certs/ca-bundle.crt ca-certificates.crt
    - docker login https://${HUB_URL} -u ${HUB_LOGIN} -p ${HUB_PASSWORD}
    - docker build -t ${HUB_URL}/godns:latest .
    - docker push ${HUB_URL}/godns

